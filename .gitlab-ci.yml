stages:
  - build
  - deploy

variables:
  NODE_ENV: production

before_script:
  - echo "Starting CI/CD Pipeline..."

build_job:
  stage: build
  image: node:22
  script:
    - echo "Installing dependencies..."
    - npm ci
    - echo "Building application..."
    - npm run build
  after_script:
    - echo "BUILD_JOB_ID=$CI_JOB_ID" >> build_job.env  
  artifacts:
    paths:
      - theme/
    expire_in: 1 hour
    reports:
      dotenv: build_job.env    
  only:
    - main
    - dev

deploy_uat:
  stage: deploy
  needs:
    - build_job
  variables:
    UPSTREAM_PROJECT_ID: $CI_PROJECT_ID
    UPSTREAM_REF_NAME: $CI_COMMIT_REF_NAME
    UPSTREAM_JOB_ID: $BUILD_JOB_ID
  trigger:
    project: datumhq-consulting-vn/management/common-services/datumhq-websites/wordpress-application
    branch: main
    strategy: depend
  only:
    - main
    - dev
